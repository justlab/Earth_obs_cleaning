---
title: "Import and process AODV3 Level2 AOD20 from Aeronet"
author: "Yang Liu"
date: "6/4/2019"
output:
  html_document:
    toc: true
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, warning=FALSE,
                      error = F, fig.width = 7, fig.height = 4.5)
```

Borrowed some code from `03_import_aeronet.R` on Jdrive  
Import and process the AOD20 V3 level 2 global Aeronet stations  
* Interpolating to wavelength AOD 470nm, the result is: 
`aod20_data_pred470 <- read.fst("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_wPredAOD_470nm_190618.fst", as.data.table = T)`

* Collocate with MCD19A2 

```{r}
source("~/liuyanguu/CWV/Code/cwv_funcs.R")
source("~/liuyanguu/AOD_CONUS/Code/funcs_for_plots.R")
```

# AERONET

Get list of stations, and NEMIA stations

```{r, eval = T}
# https://aeronet.gsfc.nasa.gov/data_push/V3/AOD/AOD_Level20_All_Points_V3.tar.gz
# load aod data
aod20_file_dir  <-  list.files("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD/AOD20/ALL_POINTS/", pattern = "*.lev20", full.names = TRUE)

# load site location file, only for limiting sites' locations to the US or to NEMIA
site_locations_2019 <- fread("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD/AOD20/aeronet_locations_v3.txt")

aod_file_name <- gsub("^[0-9]{5,}_[0-9]{5,}_|\\.lev20", "", list.files(aod20_daily_dir, pattern = "*.lev20"))

aod_file_name[!aod_file_name%in%site_locations_2019$Site_Name]
# Among the 4 sites, Kitt-Peak_MP (Kitt Peak National Observatory) and UMBC_temp are in US.
setnames(site_locations_2019, c("Site_Name", "lon", "lat", "elev"))

aod_site_sf <- st_as_sf(site_locations_2019, coords = c("lon", "lat"), crs = 4326)
nemia_buff_aea <- readRDS("~/Jdrive/PM/Just_Lab/projects/ECHO_PM/data/intermediate/nemia_buff_aea.rds")
nemia_buff = st_transform(nemia_buff_aea, crs = 4326) 


aod_site_NE <- aod_site_sf[nemia_buff,]  # a sf object for NEMIA
saveRDS(aod_site_NE, here("Intermediate", "aod_site_NE"))
# NEMIA site list
# site_list_NE <- c(aod_site_NE$Site_Name, "MVCO", "LISCO")
site_list_NE <- c(aod_site_NE$Site_Name)

# aod_file_name[aod_file_name%in%site_list_NE]

# US site list
aeronet_conus_dt <- readRDS("~/Jdrive/PM/Just_Lab/projects/ECHO_PM/data/intermediate/aeronet_conus_dt.rds")

```

create the 6.6GB global file 

```{r, eval = F}
# open one file and take a look at the data
t0 <- fread(aod20_file_dir[1])
t0[1,]  

grep("Angstrom_Exponent", names(t0), value = T)
# read one file
vars_aod <- intersect(grep("AOD_", names(t0), value = T), grep("nm", names(t0), value = T))
# sort the wave lengths from low to high, and update the vars_aod
x_nm <- sort(readr::parse_number(vars_aod))
vars_aod <- paste0("AOD_", x_nm,"nm")
vars_wv <- paste0("Exact_Wavelengths_of_AOD(um)_", x_nm,"nm")
vars0 <- c("Date(dd:mm:yyyy)", "Time(hh:mm:ss)", "Day_of_Year","AERONET_Site_Name",
             "AERONET_Instrument_Number", 
             "Site_Latitude(Degrees)", 
             "Site_Longitude(Degrees)", 
             "Site_Elevation(m)", "Ozone(Dobson)", "NO2(Dobson)")
vars0_new <- c("date", "time", "dayofYear", "site",
                "instrumentNumber", "lat", "lon", 
                 "elev", "ozone", "NO2")

read.aod <- function(site_dir, vars_read, vars_newname){
  t1 <- fread(site_dir, select = vars_read, col.names = vars_newname)
  t1[, date := as.Date(date, format = "%d:%m:%Y")]
  t1[, hour := format(strptime(time, "%H:%M:%S"), "%H")]
  for (i in names(t1)) t1[get(i) == -999, (i):= NA] # set NA 
  t1
}
system.time(
file_list <- lapply(aod20_file_dir, read.aod, vars_read = c(vars0,vars_aod,vars_wv),  vars_newname = c(vars0_new,vars_aod,vars_wv)) # 440s
)
aod20_data_global <- rbindlist(file_list) 

print(object.size(aod20_data_global), unit = "GB") # 6.6 GB
write.fst(aod20_data_global,
          "/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_global.fst",
          compress = 100)
```

## aod20_data_pred470: Interpolate AOD to 470nm wv

```{r, eval = F}
# can run from here
aod20_data_global <- read.fst("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_global.fst", as.data.table = T)
# overview: what percentage of wach wavelength is non-NA?
sapply(aod20_data_global[,..vars_aod], function(x)mean(!is.na(x)))

# The 5 main wavelengths
# aod_main <- c("AOD_340nm", "AOD_380nm", "AOD_440nm", "AOD_500nm", "AOD_675nm")
vars_wv <- grep("Exact_Wavelengths_of_AOD", names(aod20_data_global), value = T)
vars_aod <- grep("AOD_", names(aod20_data_global), value = T)
vars_aod_sub <- vars_aod[1:22]
# aod_num <- readr::parse_number(vars_aod_sub)
# Drop the last two wavelengths because they are frequently off the main trend lines
aod20_data_global <- aod20_data_global[, -c("AOD_1020nm", "AOD_1640nm"), with = F]

# % missing
# sapply(aod20_data_global[,..vars_aod_sub], function(x)mean(!is.na(x)))
# Number of AOD < 0 --> replace <0 AOD with NA
# sapply(aod20_data_global[,..vars_aod_sub], function(x)sum(x<0, na.rm=T))
aod20_data_global[, (vars_aod_sub):= lapply(.SD, function(x) replace(x, which(x<=0), NA)), .SDcol = vars_aod_sub]

# set id for obs and count non-missing AOD by row 
aod20_data_global[,obs:=.I]
setkey(aod20_data_global, obs)
aod20_data_global$N_NAAOD <- rowSums(!is.na(aod20_data_global[,..vars_aod_sub]))
# The number of available AOD to each line and their shares among all the observations:
round(table(aod20_data_global$N_NAAOD)/aod20_data_global[,.N]*100,3)
# notice that 81% have 6 non-NA points
#     1      2      3      4      5      6      7      8      9     10 
# 0.013  0.235 10.577  1.224  4.412 81.139  2.179  0.000  0.001  0.221 
 
## Fit a poly(2) regression based on Kodi's code
# DT.m2 = melt(DT, measure = list(colA, colB), value.name = c("dob", "gender"))
# subset to aods and obs column and melt
# melt two groups of columns (AOD and Exact wavelength) in the same time: 
d <- melt(aod20_data_global[, c(vars_aod_sub,vars_wv[1:22], "obs"), with = F], measure = list(vars_aod_sub, vars_wv[1:22]),value.name = c("aod", "exact_wv"))
# choose non-NA and >0 AOD
d <- d[!is.na(aod)]
# d[, variable := readr::parse_number(levels(variable))[as.integer(variable)]]
# should have points on both sides, otherwise pick out the id
obs_os <- d[, by = obs, .(oneside = (max(exact_wv)-0.47)*(min(exact_wv)-0.47)>0)][oneside ==T, obs]
saveRDS(obs_os, "~/Intermediate/AOD_data/190621_obs_same_side")
length(obs_os)/aod20_data_global[,.N] # about 0.4% have points on one side of the 470 nm 

```

## project to 470 nm

```{r, eval = F}
time0 <- Sys.time()
system.time(d2 <- d[, by = obs, .(AOD_470nm = exp(predict(lm(log(aod) ~  log(exact_wv) + I((log(exact_wv))^2)), newdata = data.frame(exact_wv = 0.47))))])
Sys.time() - time0 # 6.3 hours 6/19 for the world. 

setkey(d2, obs)
aod20_data_pred470 <- d2[aod20_data_global]
 
# If there are at least 4 non-NA, even on one side of the 470, I consider it fine,
# If there are 2 or 3 points, one side is not fine
# If there is only 1 point, set to NA, all of them are in obs_os anyway, since there is only one point
length(obs_os) # 91911 

# because for those on the one side and requires long range extrapolating: need 5 or 6 points to be valid. For those with at least 5 points, most have close points within the allowed range: "AOD_440nm" "AOD_443nm" "AOD_490nm" "AOD_500nm"

 # exterpolating with 4, 5 or 6 might be fine 
 #    1     2     3     4     5     6 
 # 3332 37551   183    54     4     8 
aod20_data_pred470[N_NAAOD<=4 & obs%in%obs_os, AOD_470nm:=NA]
aod20_data_pred470 <- aod20_data_pred470[,.(date, time, hour, dayofYear, site, 
                           lat, lon, N_NAAOD, AOD_470nm, AOD_440nm, AOD_500nm)]
date0 <- format(Sys.Date(), "%y%m%d")
# save results 
write.fst(aod20_data_pred470,          paste0("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_wPredAODat470nm_",date0, ".fst"), compress = 100)

```

AOD is projected to 470nm globally, as expected it correlates with neighbouring AOD 440nm

```{r}
# view correlation 
aod20_data_pred470 <- read.fst("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_wPredAOD_470nm_190618.fst", as.data.table = T)

aod20small <- aod20_data_pred470[sample(1:nrow(aod20_data_pred470), nrow(aod20_data_pred470)/100),]
plot.scatter.diagonal(aod20small, "AOD_440nm", "AOD_470nm")
# plot.scatter.diagonal(aod20small, "AOD_500nm", "AOD_470nm")

```

# Rolling join AOT to MAIAC (MCD19A2)

1. created aod20_NEMIA_idLST that has AERONET Site_Name matched with idLSTpair0   

```{r, eval = F}
# NEMIA with prediction in 2018
aod20_NEMIA <- aod20_data_pred470[year(date)==2018][site%in%site_list_NE]

# load the new grid of idLST and WGS
reference_lst_fst_old = "/data-belle/LST/MODIS.LST.C6/derived/conus_lst_land_glakes_2km_tiles.fst"
reference_lst_fst ="/data-belle/LST/MODIS.LST.C6/derived/conus_grid_201906.fst"
refDT = read_fst(reference_lst_fst, as.data.table = TRUE)[inNEMIA ==TRUE]

# match aod site to grid (LST id)
# aod_site_NE was produced in chuck 1
refDT_sf <- st_as_sf(refDT, coords = c("x_wgs84", "y_wgs84"), crs = 4326)
library(nngeo)
aod_site_NE_idLST <- st_join(aod_site_NE, refDT_sf, st_nn, k = 1)

setkey(aod20_NEMIA, site)
setkey(setDT(aod_site_NE_idLST), Site_Name)

# get data 2018 NEMIA aod with lst id 
aod20_NEMIA_idLST <- aod_site_NE_idLST[,.(Site_Name, idLSTpair0, x_sinu, y_sinu)][aod20_NEMIA]
aod20_NEMIA_idLST[,N_NAAOD:=NULL]
write.fst(aod20_NEMIA_idLST, "~/Intermediate/AOD_data/190628_aod20_wPred_NEMIA_idLST.fst")
aod20_NEMIA_idLST[,unique(Site_Name)]
```

2. rolling join with nearest time (join_time) and by (idLSTpair0)

```{r, eval = F}
aod20_NEMIA_idLST <- read.fst("~/Intermediate/AOD_data/190628_aod20_wPred_NEMIA_idLST.fst",as.data.table = T)
# AERONET: All times are provided as Greenwich Mean Time (GMT) for the solar day
# https://aeronet.gsfc.nasa.gov/new_web/data_description_AOD_V2.html
aod20_NEMIA_idLST[, stn_time:=as.POSIXct(paste(date, time), format = "%Y-%m-%d %H:%M:%S", tz = "UTC")]
aod20_NEMIA_idLST[, c("date", "time"):=NULL]

## this part obtain the binded NEMIA MCD19 data 
lst_files <- list.files(path = "/data-coco/mcd19/fst/nemia/2018", pattern = "mcd19_T", full.names = T)
terra0 <- read.fst(lst_files[1], as.data.table = T, columns = NULL)

read_lst <- function(sat = "terra"){
  lst_files <- list.files(path = "/data-coco/mcd19/fst/nemia/2018", pattern = "mcd19_T", full.names = T)
  if (sat != "terra") choose = "mcd19_A" else choose = "mcd19_T" # load terra by default
  lst_files <- list.files(path = "/data-coco/mcd19/fst/nemia/2018", pattern = choose, full.names = T)
  dt = rbindlist(lapply(lst_files, function(x)read.fst(x, as.data.table = T)))
  dt[, join_time:=overpass_time]
  setkey(dt, idLSTpair0, join_time)
  return(dt)
}
lst_terra <- read_lst()
# 18 GB all the lst terra in 2018 (NEMIA, one year)
print(object.size(lst_terra), unit = "GB") 
# make sure both are UTC time 
attr(aod20_NEMIA_idLST$stn_time, "tzone")
attr(lst_terra$overpass_time, "tzone")

aod20_NEMIA_idLST[, join_time:=stn_time]
setkey(aod20_NEMIA_idLST, idLSTpair0, join_time)

# rolling join (inner join)
aod_lst_terra <- aod20_NEMIA_idLST[lst_terra, roll = 'nearest', nomatch = 0]

# time difference
aod_lst_terra[, diff_time_min:= as.numeric(overpass_time - stn_time)/60]
aod_lst_terra[, within30min_t:=0]
aod_lst_terra[abs(diff_time_min)<=30, within30min_t:=1]
table(aod_lst_terra$within30min_t)
# hist(aod_lst_terra[abs(diff_time_min)<=60, diff_time_min], 20)
hist(aod_lst_terra[within30min_t==1, diff_time_min])
mean(aod_lst_terra$within30min_t)
aod_lst_terra <- aod_lst_terra[within30min_t!=0,]



# Aqua  ~~~~ #### 
lst_aqua <- read_lst("aqua")
# rolling join
aod_lst_aqua <- aod20_NEMIA_idLST[lst_aqua, roll = 'nearest', nomatch = 0]
aod_lst_aqua[,.N]

# time difference
aod_lst_aqua[, diff_time_min:= as.numeric(overpass_time - stn_time)/60]
# vars_new <- paste0(vars0,"_a")
# setnames(aod_lst_aqua, vars0, vars_new)
aod_lst_aqua <- aod_lst_aqua[abs(diff_time_min)<=30,]





# save
saveRDS(list(aod_lst_terra = aod_lst_terra, aod_lst_aqua = aod_lst_aqua), "~/Intermediate/AOD_data/190629_LSTjoinMCD19_t_a.rds")

```

## Examine the collocated dataset  

* Terra  

```{r}
# report
aod_lst_terra <- readRDS("~/Intermediate/AOD_data/190629_LSTjoinMCD19_t_a.rds")$aod_lst_terra

cat("The collocated Aeronet-MAIAC Terra dataset has",aod_lst_terra[,.N],"obs\n",
    "Then limit to within 30 minutes, non-missing MAIAC AOD data have:", aod_lst_terra[!is.na(Optical_Depth_047_t),.N],"obs \n",
    "The RMSE is ", aod_lst_terra[!is.na(Optical_Depth_047_t), round(sqrt(mean((Optical_Depth_047_t-AOD_470nm)^2)),4)],"\n")

cat("Diff_AOD: MAIAC - AERONET: \n")
aod_lst_terra[, AOD_diff := Optical_Depth_047_t - AOD_470nm]
summary(aod_lst_terra[!is.na(Optical_Depth_047_t),AOD_diff])

rmarkdown::paged_table(
aod_lst_terra[!is.na(Optical_Depth_047_t),
                   .(Site_Name, stn_time, overpass_time, diff_time_min, AOD_470nm, Optical_Depth_047_t)])

# AOD diff does not associate with time difference 
# plot.scatter(aod_lst_terra[!is.na(Optical_Depth_047_t)], "diff_time_min", "AOD_diff")

```

Plot MAIAC vs. AERONET AOD470nm

```{r}
plot.scatter.diagonal(data = aod_lst_terra[abs(diff_time_min)<=30], x = "AOD_470nm", 
                      y = "Optical_Depth_047_t")
```

Plot AERONET AOD by time    
Plot the difference by time  

```{r}
plotly::ggplotly(
ggplot(data = aod_lst_terra, aes(x = stn_time, y = AOD_470nm, color = Site_Name)) + 
  geom_point(size = 0.5, alpha = 0.8) +
  theme_bw()
)


plotly::ggplotly(
ggplot(data = aod_lst_terra, aes(x = stn_time, y = AOD_diff, color = Site_Name)) + 
  geom_point(size = 0.5, alpha = 0.8) +
  theme_bw()
)

```

* Aqua

```{r}
aod_lst_aqua <- readRDS("~/Intermediate/AOD_data/190629_LSTjoinMCD19_t_a.rds")$aod_lst_aqua
cat("The collocated Aeronet-MAIAC Terra dataset has",aod_lst_terra[,.N],"obs\n",
    "Then limit to within 30 minutes, non-missing MAIAC AOD data have:", aod_lst_aqua[!is.na(Optical_Depth_047_a),.N],"obs \n",
        "The RMSE is ", aod_lst_aqua[!is.na(Optical_Depth_047_a), round(sqrt(mean((Optical_Depth_047_a-AOD_470nm)^2)),4)],"\n")

cat("Diff_AOD: MAIAC - AERONET: \n")
aod_lst_aqua[, AOD_diff := Optical_Depth_047_a - AOD_470nm]
summary(aod_lst_aqua[!is.na(Optical_Depth_047_a),AOD_diff])


plot.scatter.diagonal(data = aod_lst_aqua[abs(diff_time_min)<=30], x = "AOD_470nm", 
                      y = "Optical_Depth_047_a")

```

# View the AOD data in US

* limit to after 2000-01-01

```{r}
aod20_data_pred470 <- read.fst("/data-coco/ECHO_PM/AeronetAODV3Level2/AOD_Level20_All_Points_V3_wPredAOD_470nm_190618.fst", as.data.table = T)
# * limit to after 2000-01-01 (98% are after 2000-01-01)
aod20_data_pred470 <- aod20_data_pred470[date>as.Date("2000-01-01"),]
aod20_data_pred470[,uniqueN(site)] # 1151 globally 

aod20_data_pred470[, `:=`(AODmean= mean(AOD_470nm, na.rm = T), dailyN = .N), by = .(site, date)]

# mean AOD by site and date 4% NA
aod20 <- na.omit(unique(aod20_data_pred470[,.(site, lon, lat, date, AODmean, dailyN)]))
# # of days and range of days
aod20[,`:=`(date1 = min(date), date2 = max(date), Ndays = .N), by = site] # 807690 

aeronetdt <- unique(aod20[,.(site, lon, lat, date1, date2, Ndays)]) # 1151 sites
sat = "AERONET"
plot.us.map.size()

aeronetdt_sf <- sf::st_as_sf(aeronetdt, coords = c("lon", "lat"), crs = 4326)
mapview::mapview(aeronetdt_sf, zcol = "Ndays", layer.name = "N_days")

cat("limit to >1000 days: \n")
mapview::mapview(aeronetdt_sf[aeronetdt_sf$Ndays>1000,], zcol = "Ndays", layer.name = "N_days [>1K]")

cat("range of date for Mexico City: \n")
range(aod20[site == "Mexico_City", date])
# mexi <- aod20_data_pred470[site == "Mexico_City"]

```



